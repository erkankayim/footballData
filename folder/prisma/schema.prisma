generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  fullName     String
  phone        String?
  role         UserRole     @default(OWNER)
  isActive     Boolean      @default(true)
  restaurantId String?
  restaurant   Restaurant?  @relation(fields: [restaurantId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  priceHistory      PriceHistory[]
  appliedSuggestions AISuggestion[]

  @@map("users")
}

model Restaurant {
  id                   String             @id @default(uuid())
  name                 String
  slug                 String             @unique
  ownerId              String?
  logoUrl              String?
  primaryColor         String?
  secondaryColor       String?
  subscriptionTier     SubscriptionTier   @default(STARTER)
  subscriptionStatus   SubscriptionStatus @default(ACTIVE)
  subscriptionEndDate  DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  users               User[]
  locations           Location[]
  categories          Category[]
  menuItems           MenuItem[]
  ingredients         Ingredient[]
  qrCodes             QRCode[]
  competitorPrices    CompetitorPrice[]
  aiSuggestions       AISuggestion[]
  orders              Order[]

  @@map("restaurants")
}

model Location {
  id           String      @id @default(uuid())
  restaurantId String
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name         String
  address      String
  city         String
  phone        String?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  qrCodes      QRCode[]
  orders       Order[]

  @@map("locations")
}

model Category {
  id           String      @id @default(uuid())
  restaurantId String
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name         String
  nameEn       String?
  nameAr       String?
  nameRu       String?
  description  String?
  icon         String?
  sortOrder    Int         @default(0)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())

  menuItems    MenuItem[]

  @@map("categories")
}

model MenuItem {
  id             String      @id @default(uuid())
  restaurantId   String
  restaurant     Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  categoryId     String
  category       Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name           String
  nameEn         String?
  nameAr         String?
  nameRu         String?
  description    String?
  descriptionEn  String?
  descriptionAr  String?
  descriptionRu  String?
  price          Float
  cost           Float       @default(0)
  profitMargin   Float?
  imageUrl       String?
  isAvailable    Boolean     @default(true)
  hasVariants    Boolean     @default(false)
  preparationTime Int?
  allergens      String?
  calories       Int?
  isVegan        Boolean     @default(false)
  isVegetarian   Boolean     @default(false)
  isGlutenFree   Boolean     @default(false)
  sortOrder      Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  variants         ItemVariant[]
  recipes          Recipe[]
  priceHistory     PriceHistory[]
  menuViews        MenuView[]
  aiSuggestions    AISuggestion[]

  @@map("menu_items")
}

model ItemVariant {
  id          String    @id @default(uuid())
  menuItemId  String
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  name        String
  price       Float
  cost        Float?
  sortOrder   Int       @default(0)
  isAvailable Boolean   @default(true)

  @@map("item_variants")
}

model Ingredient {
  id               String       @id @default(uuid())
  restaurantId     String
  restaurant       Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  name             String
  unit             String
  pricePerUnit     Float
  currentStock     Float        @default(0)
  minStockLevel    Float?
  supplier         String?
  lastOrderDate    DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  recipes          Recipe[]

  @@map("ingredients")
}

model Recipe {
  id           String      @id @default(uuid())
  menuItemId   String
  menuItem     MenuItem    @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient  @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  quantity     Float
  unit         Unit
  createdAt    DateTime    @default(now())

  @@map("recipes")
}

model CompetitorPrice {
  id                  String    @id @default(uuid())
  restaurantId        String
  restaurant          Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  competitorName      String
  competitorLocation  String?
  productName         String
  price               Float
  notes               String?
  recordedAt          DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("competitor_prices")
}

model PriceHistory {
  id         String    @id @default(uuid())
  menuItemId String
  menuItem   MenuItem  @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  oldPrice   Float
  newPrice   Float
  changedBy  String?
  user       User?     @relation(fields: [changedBy], references: [id])
  reason     String?
  changedAt  DateTime  @default(now())

  @@map("price_history")
}

model QRCode {
  id           String     @id @default(uuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  locationId   String?
  location     Location?  @relation(fields: [locationId], references: [id])
  code         String     @unique
  tableNumber  String?
  isActive     Boolean    @default(true)
  totalViews   Int        @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  menuViews    MenuView[]

  @@map("qr_codes")
}

model MenuView {
  id         String    @id @default(uuid())
  qrCodeId   String?
  qrCode     QRCode?   @relation(fields: [qrCodeId], references: [id])
  menuItemId String?
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id])
  userAgent  String?
  ipAddress  String?
  country    String?
  city       String?
  viewedAt   DateTime  @default(now())

  @@map("menu_views")
}

model AISuggestion {
  id              String           @id @default(uuid())
  restaurantId    String
  restaurant      Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItemId      String
  menuItem        MenuItem         @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  currentPrice    Float
  suggestedPrice  Float
  reasoning       String
  confidence      Float
  status          SuggestionStatus @default(PENDING)
  appliedById     String?
  appliedBy       User?            @relation(fields: [appliedById], references: [id], onDelete: SetNull)
  appliedAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@map("ai_suggestions")
}

model Order {
  id           String      @id @default(uuid())
  restaurantId String
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  locationId   String?
  location     Location?   @relation(fields: [locationId], references: [id])
  tableNumber  String?
  totalAmount  Float
  status       OrderStatus @default(PENDING)
  items        Json
  createdAt    DateTime    @default(now())
  completedAt  DateTime?

  @@map("orders")
}

// Enums
enum UserRole {
  OWNER
  MANAGER
  WAITER
  CHEF
}

enum SubscriptionTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum Unit {
  KG
  G
  L
  ML
  ADET
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
  APPLIED
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  DELIVERED
  CANCELLED
}
